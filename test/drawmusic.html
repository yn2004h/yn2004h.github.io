<!DOCTYPE html>
<html>
<head><meta charset="UTF-8">
	<meta name="viewport" content="user-scalable=no">
	<meta name="viewport" content="initial-scale=1,maximum-scale=1">
	<meta name="viewport" content="width=device-width">
	<style>
	html,body{
		height:100%;
		width:100%;
		margin:0px;
		padding:0px;
		background-color:#666666;
		overflow:hidden;
	}
	
	canvas {
		width:100%;
		height:100%;
		background-color:#ffffff;
	}
	</style>
	<title>绘音 V-0.0.5</title>
</head>
<body><canvas id="mycanvas"></canvas></body>
<script>
/*
作者：香江鱼@哔喱哔喱；香江鱼@今日头条
*/
let canvas,ctx,actx,osc,gain

window.onload = function(){
	main()
}

window.onresize = function(e){
	canvas.width = canvas.clientWidth
	canvas.height = canvas.clientHeight
	ctx = canvas.getContext('2d')
	ctx.globalAlpha = 0.1
}

function main(){
	canvas = document.querySelector('#mycanvas')
	canvas.width = canvas.clientWidth
	canvas.height = canvas.clientHeight
	ctx = canvas.getContext('2d')
	ctx.globalAlpha = 0.1
	canvas.onmousedown = function(e){
		onmousedown(e)
	}
	canvas.onmousemove = function(e){
		onmousemove(e)
	}
	canvas.onmouseup = canvas.onmouseleave = function(e){
		onmouseup(e)
	}
	canvas.addEventListener('touchstart',function(e){
		onmousedown({offsetX:e.touches[0].clientX,offsetY:e.touches[0].clientY})
		e.preventDefault()
	},false)
	canvas.addEventListener('touchmove',function(e){
		info('ontouchmove')
		onmousemove({offsetX:e.touches[0].clientX,offsetY:e.touches[0].clientY})
		e.preventDefault()
		
	},false)
	canvas.addEventListener('touchend',function(e){
		info('ontouchend')
		onmouseup({})
		e.preventDefault()
	},false)
	canvas.addEventListener('touchcancel',function(e){
		info('ontouchcancel')
		onmouseup({})
		e.preventDefault()
	},false)
}

function info(...args){
	ctx.globalAlpha = 1
	ctx.clearRect(0,0,canvas.width,25)
	ctx.fillText(args.join(','),10,20,canvas.width)
}

function onmousedown(e){
	if(!actx) initAudio()
	canvas.down = true
	playAndDraw(e)
}

function onmousemove(e){
	if(canvas.down) playAndDraw(e)
}

function onmouseup(e){
	info('onmouseup',gain)
	canvas.down = false
	if(gain) stop()
}

function playAndDraw(e){
	ctx.globalAlpha = 0.1
	play(880*(1-e.offsetY/canvas.height),0.05)
	ctx.fillRect(e.offsetX-5,e.offsetY-5,10,10)
}

function initAudio(){
	actx = new AudioContext()
	osc = actx.createOscillator()
	osc.type = 'square'
	gain = actx.createGain()
	osc.connect(gain)
	gain.connect(actx.destination)
	gain.gain.setValueAtTime(0,actx.currentTime)
	osc.start()
}

function play(fre,g){
	console.log(fre,g)
	osc.frequency.setValueAtTime(fre,actx.currentTime)
	gain.gain.setValueAtTime(g>0?g:0,actx.currentTime)
}
function stop(){
	info('stop')
	gain.gain.setValueAtTime(0,actx.currentTime)
}
</script>
</html>
